# Implementation Plan - Enhanced Chatbot Validation

The goal is to leverage Proporter's internal logic (Pydantic schemas and logic constraints) to enforce strict accuracy and validation checks on the HCL generated by the chatbot.

## User Review Required

> [!IMPORTANT]
> This plan standardizes validation across ALL resource types, not just App Installers. It ensures the chatbot cannot generate "lazy" or invalid resources.

- **Gaps Identified**:
  - `HCLGenerator` is permissive; it proceeds with defaults if data is missing.
  - `LLMService` only validates `AppInstaller` names against the catalog. It doesn't validate Policy frequencies, Script content risks, or meaningless inputs.
- **Proposed Solution**:
  - Implement a strict `Validator` class that runs _after_ Pydantic parsing but _before_ HCL generation.
  - If validation fails, the chatbot will ask clarifying questions instead of generating broken code.

## Proposed Steps

### Step 1: Create `IntentValidator` Class

- **File**: `backend/intent_validator.py`
- **Purpose**: A centralized validator for UserIntents.
- **Logic**:
  - `validate_policy`: Check frequency strings, ensure scope is not empty/dangerous.
  - `validate_script`: Ensure content isn't empty, check for forbidden characters?
  - `validate_app_installer`: Move existing logic here.
  - `validate_smart_group`: Check criteria structure.

### Step 2: Integrate Validator into `LLMService`

- **File**: `backend/llm_service.py`
- **Changes**:
  - Import `IntentValidator`.
  - In `generate_hcl`, call `validator.validate(intent)`.
  - If it returns an error string, return it as a `# NOTE: ...` or `missing_info_question`.

### Step 3: Enhance Pydantic Schemas (If needed)

- **File**: `backend/schemas.py`
- **Changes**:
  - Add regex validation for `frequency` (e.g. 'Once per computer', 'Ongoing').
  - Enforce tighter types for `priority`.

### Step 4: Add Unit Tests

- **File**: `backend/test_validation.py`
- **Tests**:
  - Test invalid policy frequency.
  - Test invalid App Installer name.
  - Test empty script content.

## Verification Plan

### Automated Tests

- Run `pytest backend/test_validation.py`.

### Manual Verification

- **Scenario 1**: Request "Policy with invalid frequency". -> Chatbot should correct/ask.
- **Scenario 2**: Request "Empty script". -> Chatbot should ask for content.
